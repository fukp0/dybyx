<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --bg: #f3f4f6;
            --sidebar: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg: #111827;
            --sidebar: #1f2937;
            --text: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; transition: 0.3s; }

        /* --- LOGIN SCREEN --- */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: var(--sidebar); padding: 2.5rem; border-radius: 1rem;
            box-shadow: var(--shadow); width: 100%; max-width: 400px;
            text-align: center; border: 1px solid var(--border);
        }
        .login-logo { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .input-group { margin-bottom: 1.2rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
        .input-field {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 0.5rem; background: var(--bg); color: var(--text);
            font-size: 1rem; transition: border 0.2s;
        }
        .input-field:focus { border-color: var(--primary); }
        .btn-full {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600;
            cursor: pointer; margin-top: 1rem; transition: 0.2s;
        }
        .btn-full:hover { background: var(--primary-dark); }
        .error-msg { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* --- DASHBOARD --- */
        .app-container { display: none; max-width: 1400px; margin: 0 auto; padding: 2rem; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-actions { display: flex; gap: 10px; }
        .btn-sm { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--sidebar); color: var(--text); cursor: pointer; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-sm:hover { background: var(--bg); }
        .btn-danger { color: var(--danger); border-color: rgba(239,68,68,0.3); }
        .btn-danger:hover { background: #fee2e2; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--sidebar); padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; box-shadow: var(--shadow); }
        .stat-icon { width: 50px; height: 50px; background: rgba(79, 70, 229, 0.1); color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info h3 { margin: 0; font-size: 1.8rem; }
        .stat-info p { margin: 0; color: var(--text-light); font-size: 0.85rem; }

        /* Toolbar */
        .toolbar { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
        .search-box { flex-grow: 1; position: relative; }
        .search-box input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 8px; border: 1px solid var(--border); background: var(--sidebar); color: var(--text); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        
        .filters button { padding: 8px 16px; border: 1px solid var(--border); background: var(--sidebar); color: var(--text-light); border-radius: 20px; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .filters button.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Grid Fichiers */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.5rem; }
        .file-card { background: var(--sidebar); border-radius: 1rem; overflow: hidden; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; display: flex; flex-direction: column; }
        .file-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        
        .preview-box { height: 160px; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .preview-box img, .preview-box video { width: 100%; height: 100%; object-fit: cover; }
        .file-icon-placeholder { font-size: 3rem; }
        
        .card-body { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .file-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .file-meta { font-size: 0.8rem; color: var(--text-light); display: flex; justify-content: space-between; margin-bottom: 15px; }
        
        .card-actions { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-card { padding: 8px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 500; }
        .btn-copy { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .btn-copy:hover { background: rgba(79, 70, 229, 0.2); }
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-del:hover { background: rgba(239, 68, 68, 0.2); }

        /* Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #10B981; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateY(100px); transition: 0.3s; z-index: 2000; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- SECTION LOGIN -->
    <div id="loginSection" class="login-wrapper">
        <div class="login-card">
            <span class="login-logo">üîê</span>
            <h2 style="margin-top:0">Administration</h2>
            <div class="input-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="userInput" class="input-field" placeholder="dyby00" autofocus>
            </div>
            <div class="input-group">
                <label>Mot de passe</label>
                <input type="password" id="passInput" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <p id="loginError" class="error-msg"></p>
            <button onclick="attemptLogin()" class="btn-full">Se Connecter</button>
            <a href="/" style="display:block; margin-top:20px; color:var(--text-light); text-decoration:none; font-size:0.9rem;">‚Üê Retour au site</a>
        </div>
    </div>

    <!-- SECTION DASHBOARD -->
    <div id="dashboardSection" class="app-container">
        
        <!-- Navbar -->
        <header class="header">
            <div class="brand">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                MediaPanel
            </div>
            <div class="nav-actions">
                <button class="btn-sm" onclick="toggleTheme()">üåì Th√®me</button>
                <a href="/" class="btn-sm" target="_blank">üåê Voir le site</a>
                <button class="btn-sm btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìÇ</div>
                <div class="stat-info">
                    <h3 id="countFiles">0</h3>
                    <p>Fichiers en ligne</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíæ</div>
                <div class="stat-info">
                    <h3 id="totalSize">0 MB</h3>
                    <p>Espace utilis√©</p>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Rechercher un fichier..." onkeyup="filterFiles()">
            </div>
            <div class="filters">
                <button class="active" onclick="setFilter('all', this)">Tout</button>
                <button onclick="setFilter('image', this)">Images</button>
                <button onclick="setFilter('video', this)">Vid√©os</button>
                <button onclick="setFilter('audio', this)">Audios</button>
            </div>
        </div>

        <!-- Liste des fichiers -->
        <div id="fileGrid" class="file-grid">
            <!-- Charg√© via JS -->
            <p style="grid-column: 1/-1; text-align:center; color:var(--text-light);">Chargement...</p>
        </div>

    </div>

    <div id="toast" class="toast">Lien copi√© !</div>

    <script>
        const API_URL = location.origin; // URL automatique
        let allFiles = []; // Stockage local pour le filtre
        let currentFilter = 'all';

        // --- 1. GESTION DU LOGIN ---
        async function attemptLogin() {
            const user = document.getElementById('userInput').value.trim();
            const pass = document.getElementById('passInput').value.trim();
            const errorMsg = document.getElementById('loginError');

            // 1. V√©rification USERNAME (C√¥t√© client pour compatibilit√© imm√©diate)
            if (user !== "dyby00") {
                errorMsg.textContent = "Nom d'utilisateur incorrect.";
                errorMsg.style.display = 'block';
                return;
            }

            // 2. V√©rification MOT DE PASSE (Via l'API Server)
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });
                
                const data = await res.json();
                
                if(data.success) {
                    // Succ√®s
                    localStorage.setItem('admin_session', 'true');
                    showDashboard();
                } else {
                    errorMsg.textContent = "Mot de passe incorrect.";
                    errorMsg.style.display = 'block';
                }
            } catch (e) {
                errorMsg.textContent = "Erreur de connexion au serveur.";
                errorMsg.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('admin_session');
            location.reload();
        }

        // V√©rification session au d√©marrage
        if(localStorage.getItem('admin_session') === 'true') {
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            loadFiles();
        }


        // --- 2. GESTION DES FICHIERS ---
        async function loadFiles() {
            try {
                const res = await fetch('/api/files');
                const files = await res.json();
                allFiles = files; // Sauvegarde pour filtrage
                renderFiles(files);
                updateStats(files);
            } catch (e) {
                document.getElementById('fileGrid').innerHTML = `<p style="color:red">Erreur chargement liste.</p>`;
            }
        }

        function renderFiles(files) {
            const grid = document.getElementById('fileGrid');
            
            if(files.length === 0) {
                grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:var(--text-light); padding:50px;">Aucun fichier trouv√©.</p>`;
                return;
            }

            grid.innerHTML = files.map(f => {
                let previewHtml = '';
                if(f.type === 'image') previewHtml = `<img src="${f.url}" loading="lazy">`;
                else if(f.type === 'video') previewHtml = `<video src="${f.url}" muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
                else previewHtml = `<span class="file-icon-placeholder">üéµ</span>`;

                // Format date
                const date = new Date(f.date).toLocaleDateString('fr-FR', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});

                return `
                <div class="file-card">
                    <div class="preview-box">
                        ${previewHtml}
                        ${f.type === 'video' ? '<span style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem">VIDEO</span>' : ''}
                    </div>
                    <div class="card-body">
                        <div class="file-name" title="${f.name}">${f.name}</div>
                        <div class="file-meta">
                            <span>${f.size}</span>
                            <span>${date}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card btn-copy" onclick="copyLink('${API_URL}${f.url}')">üîó Copier</button>
                            <button class="btn-card btn-del" onclick="deleteFile('${f.name}')">üóëÔ∏è Suppr</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateStats(files) {
            document.getElementById('countFiles').textContent = files.length;
            
            // Calcul taille totale approximative (bas√© sur les strings "XX MB")
            let total = 0;
            files.forEach(f => {
                const size = parseFloat(f.size);
                if(!isNaN(size)) total += size;
            });
            document.getElementById('totalSize').textContent = total.toFixed(2) + " MB";
        }

        // --- 3. ACTIONS ---
        async function deleteFile(name) {
            if(!confirm(`Supprimer d√©finitivement "${name}" ?`)) return;

            const res = await fetch(`/api/files/${name}`, { method: 'DELETE' });
            if(res.ok) {
                // Recharger la liste sans rafra√Æchir la page
                loadFiles(); 
            } else {
                alert("Impossible de supprimer le fichier.");
            }
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        // --- 4. FILTRES & RECHERCHE ---
        function filterFiles() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = allFiles.filter(f => {
                const matchName = f.name.toLowerCase().includes(search);
                const matchType = currentFilter === 'all' || f.type === currentFilter;
                return matchName && matchType;
            });
            
            renderFiles(filtered);
        }

        function setFilter(type, btn) {
            // Gestion UI boutons
            document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentFilter = type;
            filterFiles();
        }

        // --- 5. THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }
        if(localStorage.getItem('theme') === 'dark') toggleTheme();

    </script>
</body>
</html>
